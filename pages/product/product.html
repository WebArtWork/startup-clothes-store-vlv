<div class="container product__container">
	<section class="product">
		<div class="row">
			<div class="col-md-6">

				<!-- <div class="carousel-inner">
						<div class="carousel-item active">
							<img src="{{{product.thumb}}}" class="d-block w-100">
						</div>
						{% for thumb in product.thumbs %}
						<div class="carousel-item">
							<img src="{{{thumb}}}" alt="{{{car.name}}}" class="d-block w-100">
						</div>
						{% endfor %}
					</div>
					<button class="carousel-control-prev" type="button" data-bs-target="#carouselExample"
						data-bs-slide="prev">
						<span class="carousel-control-prev-icon" aria-hidden="true"></span>
						<span class="visually-hidden">Previous</span>
					</button>
					<button class="carousel-control-next" type="button" data-bs-target="#carouselExample"
						data-bs-slide="next">
						<span class="carousel-control-next-icon" aria-hidden="true"></span>
						<span class="visually-hidden">Next</span>
					</button>
				</div> -->
				<img id="mainPhoto" class="main-photo" src="{{{product.thumb}}}" alt="Головне фото"
					onclick="setMainPhoto('{{{product.thumb}}}')">
				<div id="thumbnails">
					<img id="mainPhoto" class="thumbnail" src="{{{product.thumb}}}" alt="Головне фото"
						onclick="setMainPhoto('{{{product.thumb}}}')">
					{% for thumb in product.thumbs %}
					<img class="thumbnail" src="{{{thumb}}}" alt="Маленьке фото" onclick="setMainPhoto('{{{thumb}}}')">
					{% endfor %}
				</div>
			</div>
			<div class="col-md-6">
				<div class="product-info">
					<div class="product-info__title">{{{product.name}}}</div>
					<div class="product-info__price">
						{{{product.price}}}&nbsp;<span>{{{currency}}}</span>
					</div>
					<!-- Colors Section -->
					<div class="product-info__cart-text">Кольори:</div>
					<div class="product-info__cart color-container">
						{% for productquantity in product.productquantity %}
						<span class="color-circle" style="background-color: {{{productquantity.color}}};"
							data-color="{{{productquantity.color}}}">
						</span>
						{% endfor %}
					</div>

					<!-- Sizes Section -->
					<div class="product-info__cart-text">Розміри:</div>
					<div class="product-info__cart size-container">
						{% for productquantity in product.productquantity %}
						{% if productquantity.quantity > 0 %}
						<span class="size available" data-size="{{{productquantity.size.name}}}"
							data-color="{{{productquantity.color}}}" id="{{{productquantity._id}}}">
							{{{productquantity.size.name}}}
						</span>
						{% endif %}
						{% if !(productquantity.quantity > 0) %}
						<span class="size no-size"
							data-size="{{{productquantity.size.name}}}">{{{productquantity.size.name}}}</span>
						{% endif %}
						{% endfor %}
					</div>
					<div class="product-info__cart">
						<button id="addToCart" type="button" class="btn product-info__cart-btn">
							Додати у кошик
						</button>
						<button id="buyNow" type="button" class="btn product-info__cart-btn">
							Купити зараз
						</button>
					</div>
					{% if product.description %}
					<div class="product-info__cart-text">Подробиці:</div>
					<div class="product-info__cart">{{{product.description|safe}}}</div>
					{% endif %}
				</div>
			</div>
			{% if product.related_products.length %}
			<div class="product-info__cart-text" style="margin-top: 40px;">Вам може сподобатись:</div>
			{% for relatedproduct in product.related_products %}
			<div class="card" style="width: 12rem; margin-right: 20px; border: none">
				<a href="/product/{{{relatedproduct.id|string}}}">
					<img src="{{{relatedproduct.thumb}}}" class="card-img-top" alt="{{{relatedproduct.name}}}">
					<p class="card-text">{{{relatedproduct.name}}}</p>
				</a>
			</div>
			{% endfor %}
		</div>
		{% endif %}

		<script type="module">
			import Dom from "/api/wjst/dom";
			import Order from "/api/wjst/order";
			const order = await Order.populated();
		
			const sizeElements = document.querySelectorAll('.size');
			const colorElements = document.querySelectorAll('.color-circle');
			let selectedColor = null;
			let selectedSize = null;
		
			// Function to update sizes based on the selected color
			const updateSizeVisibility = (color) => {
				sizeElements.forEach(sizeElement => {
					const sizeColor = sizeElement.getAttribute('data-color');
					if (sizeColor !== color) {
						sizeElement.classList.add('no-size');
					} else {
						sizeElement.classList.remove('no-size');
					}
				});
			};
		
			// Function to update colors based on the selected size
			const updateColorVisibility = (size) => {
				colorElements.forEach(colorElement => {
					let colorAvailable = false;
					sizeElements.forEach(sizeElement => {
						if (sizeElement.getAttribute('data-size') === size &&
							sizeElement.getAttribute('data-color') === colorElement.getAttribute('data-color')) {
							colorAvailable = true;
						}
					});
					if (!colorAvailable) {
						colorElement.classList.add('no-size');
					} else {
						colorElement.classList.remove('no-size');
					}
				});
			};
		
			// Handle color selection
			colorElements.forEach(element => {
				element.addEventListener('click', function () {
					// Remove 'selected' class from all colors
					colorElements.forEach(el => el.classList.remove('selected'));
		
					// Mark the clicked color as 'selected'
					element.classList.add('selected');
					selectedColor = element.getAttribute('data-color');
		
					// Show only the sizes available for the selected color
					updateSizeVisibility(selectedColor);
		
					// Allow choosing unavailable sizes for this color (they just won't trigger the cart logic)
					sizeElements.forEach(sizeElement => sizeElement.classList.remove('disabled'));
		
					// Reset the selected size when the color changes
					selectedSize = null;
					sizeElements.forEach(el => el.classList.remove('selected'));
				});
			});
		
			// Handle size selection
			sizeElements.forEach(element => {
				element.addEventListener('click', function () {
					// Allow selecting even if it’s not available, but disable adding to cart if no stock
					if (!element.classList.contains('disabled')) {
						// Remove 'selected' class from all sizes
						sizeElements.forEach(el => el.classList.remove('selected'));
		
						// Mark the clicked size as 'selected'
						element.classList.add('selected');
						selectedSize = element.getAttribute('data-size');
		
						// Show only the colors available for the selected size
						updateColorVisibility(selectedSize);
		
						// Reset the selected color when the size changes
						selectedColor = null;
						colorElements.forEach(el => el.classList.remove('selected'));
					}
				});
			});
		
			// Toggle Product Logic (if modified)
			const toggleProduct = async (quantity = 1) => {
				// Ensure both color and size are selected before toggling product
				if (!selectedColor || !selectedSize) {
					alert('Please select a color and size.');
					return;
				}
		
				const productquantity = document.getElementsByClassName('size selected')[0].id;
				const product = "{{{product.id}}}";
				await Order.toggleProduct(product, quantity, productquantity);
		
				if (await Order.hasProduct(product, productquantity)) {
					Dom.element("addToCart").innerHTML = "Забрати з кошика";
					Dom.element("addToCart").style.backgroundColor = "#6cc4cc";
				} else {
					Dom.element("addToCart").innerHTML = "Додати у кошик";
					Dom.element("addToCart").style.backgroundColor = "black";
				}
		
				Dom.element("cart").innerHTML = Dom.template('cart', {
					counter: Order.order.products.length
				});
			};
		
			Dom.click("addToCart", () => toggleProduct(1));
		
			Dom.click("buyNow", async () => {
				const product = "{{{product.id}}}";
				await toggleProduct();
				window.location.href = '/cart';
			});
		</script>
		
</div>
</section>
</div>