<div class="cart-container">
	<div class="cart-products" id="products">

	</div>
	<div class="cart-total-container">
		<h2>Total: <span class="total-amount">{{{order.total}}} {{{currency}}}</span></h2>

		<form class="cart-info-form" id="cart-info-form">
			<input type="text" disabled class="form-control" placeholder="Електрона пошта"
				aria-label="Recipient's username" aria-describedby="basic-addon2" id="email" name="email">
			<input type="text" class="form-control" placeholder="Ім'я та прізвище" aria-label="Username" id="name"
				name="name">
			<input type="text" list="cities" class="form-control" placeholder="Місто" id="city" name="city"
				aria-describedby="basic-addon2">
			<datalist id="cities">
				<option value="Київ">
				<option value="Харків">
				<option value="Одеса">
				<option value="Дніпро">
				<option value="Кам'янець-Подільський">
					<!-- Add more cities here -->
			</datalist>
			<input type="text" class="form-control" placeholder="Адреса доставки або номер відділення Нової пошти"
				id="address" name="address" aria-describedby="basic-addon2">
			<input type="text" class="form-control" placeholder="Телефон" id="phone" name="phone"
				aria-describedby="basic-addon2">
			<button type="submit" class="cart-checkout-btn">Замовити</button>
		</form>
	</div>

	<div id="template-products" style="display: none;">
		<div class="cart-product" id="remove{id}">
			<img src="{thumb}" alt="Product 1" class="product-image">
			<span class="cart-product-name">{name} - {price}
				{currency}</span>
			<div class="product-quantity">
				<button productId="{id}" class="quantity-minus">-</button>
				<input id="id{id}" type="number" class="quantity-value" value="{quantity}" min="1">
				<button productId="{id}" class="quantity-plus">+</button>
			</div>
			<span class="product-total-price">{price * quantity}
				{currency}</span>
		</div>
	</div>

	<script type="module">
		import Dom from "/api/wjst/dom";
		import Order from "/api/wjst/order";
		import Event from "/api/wjst/event";
		import Http from '/api/wjst/http';
		const resp = await Http.post('/api/user/fetchme', {})
		const order = await Order.populated();
		for (const product of order.products) {
			Dom.add('products', Dom.template('products', {
				name: product.product.name,
				currency: product.currency,
				price: product.price,
				quantity: product.quantity,
				status: product.product.status,
				thumb: product.product.thumb,
				id: product._id

			}));
		}
		resp.data = resp.data || {}
		Dom.element('email').value = resp.email || "";
		Dom.element('name').value = resp.data.name || "";
		Dom.element('city').value = resp.data.city || "";
		Dom.element('address').value = resp.data.address || "";
		Dom.element('phone').value = resp.data.phone || "";
		// Dom.submit('cart-info-form', async data => {
		// 	Order.order.data = {
		// 		...Order.order.data,
		// 		...data
		// 	}
		// 	await Order.update(Order.order);
		// 	const url = await Order.pay();
		// 	window.location.href = url;
		// 	console.log(url)
		// });
		Dom.click('.quantity-minus', async (element) => {
			const productId = element.getAttribute('productId');
			const value = Number(Dom.element('id' + productId).value) - 1;
			if (value > 0) {
				Dom.element('id' + productId).value = value;
				for (const orderproduct of order.products) {
					if (orderproduct.product._id === productId) {
						orderproduct.quantity = value;
					}
				}
			} else {
				order.products = order.products.filter(p => p.product !== productId);
				Dom.element("cart").innerHTML = Dom.template('cart', {
					counter: order.products.length
				});
				Dom.element('remove' + productId).innerHTML = '';

			}
			const total = orderproduct.price * value;
			Dom.element('remove' + productId).querySelector('.product-total-price').textContent = total + ' ' + orderproduct.currency;
			await Order.update(order);
		});
		Dom.click('.quantity-plus', async (element) => {
			const productId = element.getAttribute('productId');
			const currentValueElement = Dom.element('id' + productId);
			const currentValue = Number(currentValueElement.value);
			currentValueElement.value = currentValue + 1;

			for (const orderproduct of order.products) {
				if (orderproduct.product._id === productId) {
					orderproduct.quantity = currentValue + 1;
					break;
				}
			}

			const total = orderproduct.price * (currentValue + 1);
			Dom.element('remove' + productId).querySelector('.product-total-price').textContent = total + ' ' + orderproduct.currency;

			await Order.update(order);
		});

	</script>
</div>