<div class="cart-container">
	<div class="cart-products">
		{% for orderproduct in order.products %}
			<div class="cart-product" id="remove{{{orderproduct.product._id}}}">
				<img src="{{{orderproduct.product.thumb}}}" alt="Product 1" class="product-image">
				<span class="cart-product-name">{{{orderproduct.product.name}}} - {{{orderproduct.product.price}}}
					{{{currency}}}</span>
				<div class="product-quantity">
					<button productId="{{{orderproduct.product._id}}}" class="quantity-minus">-</button>
					<input id="id{{{orderproduct.product._id}}}" type="number" class="quantity-value"
						value="{{{orderproduct.quantity}}}" min="1">
					<button productId="{{{orderproduct.product._id}}}" class="quantity-plus">+</button>
				</div>
				<span class="product-total-price">{{{orderproduct.product.price * orderproduct.quantity}}}
					{{{currency}}}</span>
			</div>
		{% endfor %}
	</div>
	<div class="cart-total-container">
		<h2>Total: <span class="total-amount">{{{order.total}}} {{{currency}}}</span></h2>

		<form class="cart-info-form" id="cart-info-form">
			<input type="text" disabled class="form-control" placeholder="Електрона пошта"
				aria-label="Recipient's username" aria-describedby="basic-addon2" id="email" name="email">
			<input type="text" class="form-control" placeholder="Ім'я та прізвище" aria-label="Username" id="name"
				name="name">
			<input type="text" list="cities" class="form-control" placeholder="Місто" id="city" name="city"
				aria-describedby="basic-addon2">
			<datalist id="cities">
				<option value="Київ">
				<option value="Харків">
				<option value="Одеса">
				<option value="Дніпро">
				<option value="Кам'янець-Подільський">
					<!-- Add more cities here -->
			</datalist>
			<input type="text" class="form-control" placeholder="Адреса доставки або номер відділення Нової пошти"
				id="address" name="address" aria-describedby="basic-addon2">
			<input type="text" class="form-control" placeholder="Телефон" id="phone" name="phone"
				aria-describedby="basic-addon2">
			<button type="submit" class="cart-checkout-btn">Замовити</button>
		</form>
	</div>

	<script type="module">
		import Dom from "/api/wjst/dom";
		import Order from "/api/wjst/order";
		import Event from "/api/wjst/event";
		import Http from '/api/wjst/http';
		const resp = await Http.post('/api/user/fetchme', {})
		console.log(Order.order);
		resp.data = resp.data || {}
		Dom.element('email').value = resp.email || "";
		Dom.element('name').value = resp.data.name || "";
		Dom.element('city').value = resp.data.city || "";
		Dom.element('address').value = resp.data.address || "";
		Dom.element('phone').value = resp.data.phone || "";
		Dom.submit('cart-info-form', async data => {
			Order.order.data = {
				...Order.order.data,
				...data
			}
			await Order.update(Order.order);
			const url = await Order.pay();
			window.location.href = url;
			console.log(url)
		});
		Dom.click('.quantity-minus', async (element) => {
			const productId = element.getAttribute('productId');
			const value = Number(Dom.element('id' + productId).value) - 1;
			if (value > 0) {
				Dom.element('id' + productId).value = value;
				for (const orderproduct of Order.order.products) {
					if (orderproduct.product === productId) {
						orderproduct.quantity = value;
					}
				}
			} else {
				Order.order.products = Order.order.products.filter(p => p.product !== productId);
				Dom.element("cart").innerHTML = Dom.template('cart', {
					counter: Order.order.products.length
				});
				Dom.element('remove' + productId).innerHTML = '';
			}
			await Order.update(Order.order);
		});
		Dom.click('.quantity-plus', async (element) => {
			const productId = element.getAttribute('productId');
			const currentValueElement = Dom.element('id' + productId);
			const currentValue = Number(currentValueElement.value);
			currentValueElement.value = currentValue + 1;

			for (const orderproduct of Order.order.products) {
				if (orderproduct.product === productId) {
					orderproduct.quantity = currentValue + 1;
					break;
				}
			}

			await Order.update(Order.order);
		});

	</script>
</div>